<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard â€” Code Everyday</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>

<!-- â”€â”€ Top Nav â”€â”€ -->
<nav class="navbar">
  <div class="nav-brand">
    <span class="brand-icon">&lt;/&gt;</span>
    <span class="brand-name">Code Everyday</span>
  </div>
  <div class="nav-center">
    <span class="nav-date" id="nav-date"></span>
  </div>
  <div class="nav-right">
    <div class="nav-user-pill">
      <span class="nav-user-icon">ğŸ‘¤</span>
      <span class="nav-username">{{ username }}</span>
    </div>
    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
  </div>
</nav>

<!-- â”€â”€ Main Layout â”€â”€ -->
<main class="main-layout">

  <!-- LEFT: Question Panel -->
  <section class="panel panel--question">
    <div class="panel-header">
      <div class="pill pill--daily">ğŸ“… Daily Challenge</div>
      <span class="panel-date" id="today-date"></span>
    </div>

    <h2 class="question-title">{{ question_title }}</h2>

    <div class="question-body">
      {% for line in question_desc.split('\n') %}
        {% if line.strip().startswith('**') and line.strip().endswith('**') %}
          <h4 class="q-section-heading">{{ line.replace('**','') }}</h4>
        {% elif line.strip() == '' %}
          <div style="height:8px"></div>
        {% else %}
          <p>{{ line }}</p>
        {% endif %}
      {% endfor %}
    </div>

    <div class="io-examples">
      <div class="io-block">
        <div class="io-label">
          <span class="io-icon">â†’</span> Sample Input
        </div>
        <pre class="io-pre">{{ sample_input }}</pre>
      </div>
      <div class="io-block">
        <div class="io-label">
          <span class="io-icon">â†</span> Sample Output
        </div>
        <pre class="io-pre">{{ sample_output }}</pre>
      </div>
    </div>

    <div class="tips-box">
      <div class="tips-title">ğŸ’¡ Tips for beginners</div>
      <ul class="tips-list">
        <li>Read the problem carefully and understand the sample I/O first.</li>
        <li>Use the <strong>Run</strong> button to test with your own inputs before submitting.</li>
        <li>Think about edge cases: empty input, single element, negatives.</li>
      </ul>
    </div>
  </section>

  <!-- RIGHT: Code Editor Panel -->
  <section class="panel panel--editor">

    <!-- Language Selector -->
    <div class="editor-toolbar">
      <label for="language" class="toolbar-label">Language</label>
      <select name="language" id="language" class="lang-select">
        <option value="python3">ğŸ Python 3</option>
        <option value="cpp">âš™ï¸ C++</option>
        <option value="c">ğŸ”§ C</option>
        <option value="java">â˜• Java</option>
        <option value="javascript">ğŸŸ¨ JavaScript</option>
      </select>
      <div class="toolbar-spacer"></div>
      <button type="button" class="btn-clear" onclick="clearCode()" title="Clear editor">ğŸ—‘ Clear</button>
    </div>

    <!-- Code Area with line numbers -->
    <div class="code-wrap" id="code-wrap">
      <div class="line-nums" id="line-nums">1</div>
      <textarea
        id="code-input"
        class="code-area"
        placeholder="# Write your solution here...&#10;# Press Tab for 4 spaces&#10;# Click Run to test, Submit to judge"
        spellcheck="false"
        autocorrect="off"
        autocapitalize="off"
        autocomplete="off"></textarea>
    </div>

    <!-- Custom Input -->
    <div class="custom-input-block">
      <label for="custom-input" class="input-label">
        <span>ğŸ§ª Custom Input</span>
        <span class="label-hint">Used by the Run button</span>
      </label>
      <textarea
        id="custom-input"
        class="custom-input-area"
        placeholder="Enter your own test input here..."
        spellcheck="false"></textarea>
    </div>

    <!-- Action Buttons -->
    <div class="btn-row">
      <button type="button" id="btn-run" class="btn btn--run" onclick="handleRun()">
        â–¶ Run
      </button>
      <button type="button" id="btn-submit" class="btn btn--submit" onclick="handleSubmit()">
        âœ“ Submit
      </button>
    </div>

    <!-- Output Panel (Run result) -->
    <div class="result-panel result-panel--output" id="output-panel" hidden>
      <div class="result-panel-header">
        <span class="result-label">ğŸ“¤ Output</span>
        <button class="result-close" onclick="document.getElementById('output-panel').hidden=true">âœ•</button>
      </div>
      <pre class="result-pre" id="output-text"></pre>
    </div>

    <!-- Verdict Panel (Submit result) -->
    <div class="result-panel result-panel--verdict" id="verdict-panel" hidden>
      <div class="result-panel-header">
        <span class="result-label">ğŸ† Verdict</span>
        <button class="result-close" onclick="document.getElementById('verdict-panel').hidden=true">âœ•</button>
      </div>
      <div class="verdict-content">
        <div class="verdict-text" id="verdict-text"></div>
        <div class="verdict-score" id="verdict-score"></div>
        <div class="verdict-bar" id="verdict-bar-wrap">
          <div class="verdict-bar-fill" id="verdict-bar-fill"></div>
        </div>
        <div class="verdict-errors" id="verdict-errors"></div>
      </div>
    </div>

  </section>
</main>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay" hidden>
  <div class="loading-box">
    <div class="spinner"></div>
    <div class="loading-title" id="loading-title">Running your code...</div>
    <div class="loading-sub" id="loading-sub">Connecting to execution server</div>
  </div>
</div>

<script>
  // â”€â”€ Date display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const dateStr = new Date().toLocaleDateString('en-US', {
    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
  });
  document.getElementById('today-date').textContent = dateStr;
  document.getElementById('nav-date').textContent = dateStr;

  // â”€â”€ Line numbers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ta = document.getElementById('code-input');
  const ln = document.getElementById('line-nums');

  function updateLines() {
    const lines = ta.value.split('\n').length;
    ln.textContent = Array.from({length: lines}, (_, i) => i + 1).join('\n');
  }
  ta.addEventListener('input', updateLines);
  updateLines();

  // Sync scroll between line numbers and code area
  ta.addEventListener('scroll', () => { ln.scrollTop = ta.scrollTop; });

  // Tab key â†’ 4 spaces
  ta.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = this.selectionStart, end = this.selectionEnd;
      this.value = this.value.substring(0, s) + '    ' + this.value.substring(end);
      this.selectionStart = this.selectionEnd = s + 4;
      updateLines();
    }
  });

  // â”€â”€ Clear code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearCode() {
    if (ta.value && confirm('Clear the editor? This cannot be undone.')) {
      ta.value = '';
      updateLines();
    }
  }

  // â”€â”€ Loading helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showLoading(title, sub) {
    document.getElementById('loading-title').textContent = title;
    document.getElementById('loading-sub').textContent = sub;
    document.getElementById('loading-overlay').hidden = false;
  }

  function hideLoading() {
    document.getElementById('loading-overlay').hidden = true;
  }

  function setBtn(id, text, disabled) {
    const b = document.getElementById(id);
    b.textContent = text;
    b.disabled = disabled;
  }

  // â”€â”€ Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleRun() {
    const code = ta.value.trim();
    if (!code) { alert('Please write some code first!'); return; }

    showLoading('â–¶ Running your code...', 'Sending to execution server...');
    setBtn('btn-run', 'â³ Running...', true);
    document.getElementById('output-panel').hidden = true;

    try {
      const res = await fetch('/api/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          language: document.getElementById('language').value,
          code: code,
          custom_input: document.getElementById('custom-input').value,
        })
      });
      const data = await res.json();
      showRunOutput(data.output || '(no output)', data.ok !== false);
    } catch (err) {
      showRunOutput('Network error: ' + err.message, false);
    } finally {
      hideLoading();
      setBtn('btn-run', 'â–¶ Run', false);
    }
  }

  function showRunOutput(text, ok) {
    const panel = document.getElementById('output-panel');
    const pre = document.getElementById('output-text');
    pre.textContent = text;
    pre.className = 'result-pre' + (ok ? '' : ' result-pre--error');
    panel.hidden = false;
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function handleSubmit() {
    const code = ta.value.trim();
    if (!code) { alert('Please write some code first!'); return; }

    showLoading('â³ Judging your solution...', 'Running test cases (this may take 30â€“60 seconds)...');
    setBtn('btn-submit', 'â³ Judging...', true);
    document.getElementById('verdict-panel').hidden = true;

    // Animate sub-text while waiting
    const subs = [
      'Running test cases...',
      'Checking edge cases...',
      'Almost done...',
      'Comparing outputs...',
    ];
    let si = 0;
    const subTimer = setInterval(() => {
      si = (si + 1) % subs.length;
      document.getElementById('loading-sub').textContent = subs[si];
    }, 4000);

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          language: document.getElementById('language').value,
          code: code,
        })
      });
      const data = await res.json();
      clearInterval(subTimer);
      showVerdict(data);
    } catch (err) {
      clearInterval(subTimer);
      showVerdict({ ok: false, verdict: 'Network error: ' + err.message, passed: 0, total: 0 });
    } finally {
      hideLoading();
      setBtn('btn-submit', 'âœ“ Submit', false);
    }
  }

  function showVerdict(data) {
    const panel = document.getElementById('verdict-panel');
    const vText = document.getElementById('verdict-text');
    const vScore = document.getElementById('verdict-score');
    const vBarFill = document.getElementById('verdict-bar-fill');
    const vBarWrap = document.getElementById('verdict-bar-wrap');
    const vErrors = document.getElementById('verdict-errors');

    const accepted = data.verdict === 'Accepted';

    // Set verdict text and style
    vText.textContent = accepted ? 'âœ“ Accepted!' : 'âœ— ' + (data.verdict || 'Wrong Answer');
    vText.className = 'verdict-text ' + (accepted ? 'verdict-text--accepted' : 'verdict-text--wrong');
    panel.className = 'result-panel result-panel--verdict ' + (accepted ? 'verdict--accepted' : 'verdict--wrong');

    // Score line
    if (data.total > 0) {
      vScore.textContent = `${data.passed} / ${data.total} test cases passed`;
      vBarWrap.hidden = false;
      const pct = Math.round((data.passed / data.total) * 100);
      vBarFill.style.width = '0%';
      setTimeout(() => { vBarFill.style.width = pct + '%'; }, 100);
      vBarFill.style.background = accepted ? 'var(--accent)' : 'var(--accent-err)';
    } else {
      vScore.textContent = data.total === 0 ? 'No test cases available.' : '';
      vBarWrap.hidden = true;
    }

    // Show first few failed test cases for learning
    vErrors.innerHTML = '';
    if (!accepted && data.errors && data.errors.length > 0) {
      const title = document.createElement('div');
      title.className = 'errors-title';
      title.textContent = `First ${data.errors.length} failing test case${data.errors.length > 1 ? 's' : ''}:`;
      vErrors.appendChild(title);

      data.errors.forEach(e => {
        const card = document.createElement('div');
        card.className = 'error-card';
        card.innerHTML = `
          <div class="error-row"><span class="error-key">Test #${e.test}</span></div>
          <div class="error-row"><span class="error-key">Input:</span><code>${escHtml(e.input)}</code></div>
          <div class="error-row"><span class="error-key">Expected:</span><code class="exp">${escHtml(e.expected)}</code></div>
          <div class="error-row"><span class="error-key">Got:</span><code class="got">${escHtml(e.got)}</code></div>
        `;
        vErrors.appendChild(card);
      });
    }

    panel.hidden = false;
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function escHtml(s) {
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
</script>
</body>
</html>