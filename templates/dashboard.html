<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard ‚Äî Code Everyday</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>

<nav class="navbar">
  <div class="nav-brand">
    <span class="brand-icon">&lt;/&gt;</span>
    <span class="brand-name">Code Everyday</span>
  </div>
  <div class="nav-right">
    <span class="nav-user">üë§ {{ username }}</span>
    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
  </div>
</nav>

<main class="main-layout">

  <section class="panel panel--question">
    <div class="panel-header">
      <div class="pill pill--daily">Daily Challenge</div>
      <span class="panel-date" id="today-date"></span>
    </div>
    <h2 class="question-title">{{ question_title }}</h2>
    <div class="question-body">
      {% for line in question_desc.split('\n') %}
        {% if line.strip() == '' %}<br>
        {% else %}<p>{{ line }}</p>{% endif %}
      {% endfor %}
    </div>
    <div class="io-examples">
      <div class="io-block">
        <div class="io-label">Sample Input</div>
        <pre class="io-pre">{{ sample_input }}</pre>
      </div>
      <div class="io-block">
        <div class="io-label">Sample Output</div>
        <pre class="io-pre">{{ sample_output }}</pre>
      </div>
    </div>
  </section>

  <section class="panel panel--editor">

    <div class="editor-toolbar">
      <label class="toolbar-label">Language</label>
      <select id="language" class="lang-select">
        <option value="python3">üêç Python 3</option>
        <option value="c">C</option>
        <option value="cpp">C++</option>
        <option value="java">‚òï Java</option>
        <option value="javascript">JS</option>
      </select>
    </div>

    <div class="code-wrap">
      <div class="line-nums" id="line-nums">1</div>
      <textarea id="code-input" class="code-area"
        placeholder="# Write your solution here..."
        spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>
    </div>

    <div class="custom-input-block">
      <label class="input-label">
        Custom Input <span class="label-hint">(used by Run)</span>
      </label>
      <textarea id="custom-input" class="custom-input-area"
        placeholder="Enter test input here..." spellcheck="false"></textarea>
    </div>

    <div class="btn-row">
      <button id="btn-run" class="btn btn--run" onclick="handleRun()">‚ñ∂ Run</button>
      <button id="btn-submit" class="btn btn--submit" onclick="handleSubmit()">‚úì Submit</button>
    </div>

    <div id="output-panel" class="result-panel" style="display:none">
      <div class="result-label">Output</div>
      <pre id="output-text" class="result-pre"></pre>
    </div>

    <div id="verdict-panel" class="result-panel result-panel--verdict" style="display:none">
      <div class="result-label">Verdict</div>
      <div id="verdict-text" class="verdict-text"></div>
      <div id="verdict-score" class="verdict-score"></div>
      <div class="verdict-bar"><div id="verdict-bar-fill" class="verdict-bar-fill"></div></div>
      <div id="verdict-errors"></div>
    </div>

  </section>
</main>

<script>
  document.getElementById('today-date').textContent =
    new Date().toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  const ta = document.getElementById('code-input');
  const ln = document.getElementById('line-nums');

  function updateLines() {
    const count = ta.value.split('\n').length;
    ln.textContent = Array.from({length: count}, (_, i) => i + 1).join('\n');
  }
  ta.addEventListener('input', updateLines);
  ta.addEventListener('scroll', () => { ln.scrollTop = ta.scrollTop; });
  updateLines();

  ta.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      const s = this.selectionStart;
      this.value = this.value.substring(0, s) + '    ' + this.value.substring(this.selectionEnd);
      this.selectionStart = this.selectionEnd = s + 4;
      updateLines();
    }
  });

  function setBtn(id, text, off) {
    const b = document.getElementById(id);
    b.textContent = text;
    b.disabled = off;
  }

  async function handleRun() {
    const code = ta.value.trim();
    if (!code) { alert('Write some code first!'); return; }
    setBtn('btn-run', '‚è≥ Running...', true);
    document.getElementById('output-panel').style.display = 'none';
    try {
      const res  = await fetch('/api/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          language: document.getElementById('language').value,
          code: code,
          custom_input: document.getElementById('custom-input').value
        })
      });
      const data = await res.json();
      document.getElementById('output-text').textContent = data.output || '(no output)';
      document.getElementById('output-panel').style.display = 'block';
    } catch (err) {
      document.getElementById('output-text').textContent = 'Network error: ' + err.message;
      document.getElementById('output-panel').style.display = 'block';
    }
    setBtn('btn-run', '‚ñ∂ Run', false);
  }

  async function handleSubmit() {
    const code = ta.value.trim();
    if (!code) { alert('Write some code first!'); return; }
    setBtn('btn-submit', '‚è≥ Judging...', true);
    document.getElementById('verdict-panel').style.display = 'none';
    try {
      const res  = await fetch('/api/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          language: document.getElementById('language').value,
          code: code
        })
      });
      const data = await res.json();
      const ok   = data.verdict === 'Accepted';
      const vp   = document.getElementById('verdict-panel');
      vp.className = 'result-panel result-panel--verdict ' + (ok ? 'verdict--accepted' : 'verdict--wrong');
      document.getElementById('verdict-text').textContent  = ok ? 'Accepted ‚úì' : 'Wrong Answer ‚úó';
      document.getElementById('verdict-score').textContent = data.total > 0 ? `${data.passed} / ${data.total} test cases passed` : '';
      const fill = document.getElementById('verdict-bar-fill');
      fill.style.width = data.total > 0 ? Math.round(data.passed / data.total * 100) + '%' : '0%';
      const errDiv = document.getElementById('verdict-errors');
      errDiv.innerHTML = '';
      if (!ok && data.errors && data.errors.length > 0) {
        data.errors.forEach(e => {
          errDiv.innerHTML += `<div class="error-card">
            <b>Test #${e.test}</b><br>
            Input: <code>${e.input}</code><br>
            Expected: <code style="color:#4ade80">${e.expected}</code><br>
            Got: <code style="color:#f87171">${e.got}</code>
          </div>`;
        });
      }
      vp.style.display = 'block';
    } catch (err) {
      document.getElementById('verdict-text').textContent = 'Network error: ' + err.message;
      document.getElementById('verdict-panel').style.display = 'block';
    }
    setBtn('btn-submit', '‚úì Submit', false);
  }
</script>

</body>
</html>